<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CovidCAR is intended to facilitate Covid19 model building, ensembling, and evalutaion">
<title>CovidCAR Package Overview • CovidCAR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="CovidCAR Package Overview">
<meta property="og:description" content="CovidCAR is intended to facilitate Covid19 model building, ensembling, and evalutaion">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">CovidCAR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reference">Reference</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reference">
    <a class="dropdown-item" href="../reference/index.html">Function Descriptions</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction.html">Introduction and Overview</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/JMHumphreys/CovidCAR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>CovidCAR Package Overview</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JMHumphreys/CovidCAR/blob/HEAD/vignettes/articles/introduction.Rmd" class="external-link"><code>vignettes/articles/introduction.Rmd</code></a></small>
      <div class="d-none name"><code>introduction.Rmd</code></div>
    </div>

    
    
<style type="text/css">

body, td {
   font-size: 13pt;
}
code.r{
  font-size: 11pt;
}
pre {
  font-size: 11pt
}
</style>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This introduction briefly outlines core functions used to preprocess
observation data, build spatial-temporal models, and post-process model
outputs. Its purpose is to demonstrate a standard workflow not to
provide an in depth examination of functions or model building
techniques.</p>
<div class="section level3">
<h3 id="resources">Resources<a class="anchor" aria-label="anchor" href="#resources"></a>
</h3>
<ul>
<li>
<a href="https://github.com/JMHumphreys/CovidCAR" class="external-link">The CovidCAR
GitHub page</a><br>
</li>
<li><a href="https://jmhumphreys.github.io/CovidCAR/reference/index.html">CovidCAR
Functions Reference</a></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="preliminaries">Preliminaries<a class="anchor" aria-label="anchor" href="#preliminaries"></a>
</h2>
<p><strong>Load needed packages</strong><br>
A few of these packages are not available on CRAN and will need to be
installed from other locations.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#comments and prompts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>dplyr.summarise.inform <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://cli.r-lib.org" class="external-link">cli</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#wrangling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://hbiostat.org/R/Hmisc/" class="external-link">Hmisc</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/vubiostat/r-yaml/" class="external-link">yaml</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#spatial manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/" class="external-link">sp</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-forge.r-project.org/projects/rgeos/" class="external-link">rgeos</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/" class="external-link">igraph</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://maptools.r-forge.r-project.org/" class="external-link">maptools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mapproj</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#census data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.hrecht.com/censusapi/" class="external-link">censusapi</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#forecast data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/reichlab/zoltr" class="external-link">zoltr</a></span><span class="op">)</span> <span class="co">#Not available on CRAN</span></span>
<span><span class="co">#remotes::install_github("reichlab/zoltr")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/reichlab/covidHubUtils" class="external-link">covidHubUtils</a></span><span class="op">)</span> <span class="co">#Not available on CRAN</span></span>
<span><span class="co">#remotes::install_github("reichlab/covidHubUtils")</span></span>
<span></span>
<span><span class="co">#inference</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span> <span class="co">#Not available on CRAN</span></span>
<span><span class="co">#install.packages("INLA",repos=c(getOption("repos"),</span></span>
<span><span class="co">#INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mrc-ide/EpiEstim" class="external-link">EpiEstim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.robjhyndman.com/forecast/" class="external-link">forecast</a></span><span class="op">)</span></span></code></pre></div>
<p><a href="https://github.com/JMHumphreys/CovidCAR" class="external-link"><strong>CovidCAR</strong></a>
currently on GitHub</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jmhumphreys.github.io/CovidCAR/">CovidCAR</a></span><span class="op">)</span></span>
<span><span class="co">#devtools::install_github("JMHumphreys/CovidCAR")</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setup-analysis">Setup Analysis<a class="anchor" aria-label="anchor" href="#setup-analysis"></a>
</h2>
<div class="section level3">
<h3 id="specifiy-dates-and-directories">Specifiy Dates and Directories<a class="anchor" aria-label="anchor" href="#specifiy-dates-and-directories"></a>
</h3>
<p>The <em>setup_analysis()</em> function defines key date thresholds
for model training and forecast horizon periods and should always be run
before using any other functions in the <strong>CovidCAR</strong>
package. The dates are written to a yaml file for use by other
functions.</p>
<p>The function also allows for recording directory paths to
(optionally) write outputs outside of the working directory or to pull
previously cached observation data (cache as created with
<strong>Covid19Forecast</strong>.v1).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_ouputs</span> <span class="op">&lt;-</span> <span class="st">"C:/Users/unp7/Desktop/Misc/CovidCAR_tests"</span></span>
<span><span class="va">my_local</span> <span class="op">&lt;-</span> <span class="st">"C:/Users/unp7/Desktop/GitHub/covid19Forecasts/local/cache"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/setup_analysis.html">setup_analysis</a></span><span class="op">(</span>report_date <span class="op">=</span> <span class="st">"2021-08-23"</span>, <span class="co">#report date, first forecast day</span></span>
<span>               training_period <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="fl">28</span>, <span class="co">#days</span></span>
<span>               forecast_horizon <span class="op">=</span> <span class="fl">28</span>, <span class="co">#days</span></span>
<span>               output_dir <span class="op">=</span> <span class="va">my_ouputs</span>, <span class="co">#write outputs here</span></span>
<span>               local_cache_dir <span class="op">=</span> <span class="va">my_local</span> <span class="co">#cache</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## → Your local cache will be available to get_covid19_obs()</span></span></code></pre>
<pre><code><span><span class="co">## → Analysis outputs will be written to C:/Users/unp7/Desktop/Misc/CovidCAR_tests/2021-08-23-CovidCAR-run2023-05-25</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="define-spatial-domain">Define Spatial Domain<a class="anchor" aria-label="anchor" href="#define-spatial-domain"></a>
</h3>
<p>The <em>download_boundaries()</em> function pulls US State and
territorial boundaries (ESRI shapefiles) from sources in the public
domain. Some basic projection is performed, the shapefile is converted
to a SpatialPolygonsDataFrame, and data attributes for a location
identifier (‘Region’) and name (‘State’) are appended to the object.</p>
<p>NOTE: The function includes an option to download county boundaries
(unit=“county”) but there are some timeout issues that need to be
resolved due to large file size.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">States</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/download_boundaries.html">download_boundaries</a></span><span class="op">(</span>unit <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## → Downloading polygon files...</span></span></code></pre>
<pre><code><span><span class="co">## Reading layer `us-state-boundaries' from data source </span></span>
<span><span class="co">##   `C:\Users\unp7\Desktop\Misc\CovidCAR_tests\2021-08-23-CovidCAR-run2023-05-25\polygons' </span></span>
<span><span class="co">##   using driver `ESRI Shapefile'</span></span>
<span><span class="co">## Simple feature collection with 56 features and 20 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: -179.2311 ymin: -14.60181 xmax: 179.8597 ymax: 71.44069</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">States</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "SpatialPolygonsDataFrame"</span></span>
<span><span class="co">## attr(,"package")</span></span>
<span><span class="co">## [1] "sp"</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">States</span><span class="op">@</span><span class="va">data</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Region"</span>, <span class="st">"State"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co">#appended attributes  </span></span></code></pre></div>
<pre><code><span><span class="co">##   Region                    State</span></span>
<span><span class="co">## 1      1              Puerto Rico</span></span>
<span><span class="co">## 2      2 Northern Mariana Islands</span></span>
<span><span class="co">## 3      3                 Arkansas</span></span>
<span><span class="co">## 4      4            West Virginia</span></span>
<span><span class="co">## 5      5             Rhode Island</span></span>
<span><span class="co">## 6      6               Washington</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="adjacency-graph">Adjacency Graph<a class="anchor" aria-label="anchor" href="#adjacency-graph"></a>
</h3>
<p>The <em>get_neighbors()</em> function is used to identify polygons
(States and Territories in this example) that are located next to each
other. Neighbor information is recorded in a matrix (dimensions:
location*location) that is included with the CAR model. Estimates for
any one location are then ‘conditional’ on the estimates for surrounding
locations.</p>
<p>NOTE: Polygons representing locations such as Hawaii and Guam are
isolated from other locations (termed ‘islands’) and can be problematic.
One option in this situation is to force connections between locations;
the function’s ‘connect’ option will force connections between islands
and other locations based on proximity.</p>
<p><strong>Example: Islands with “no links”</strong></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_islands</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_neighbors.html">get_neighbors</a></span><span class="op">(</span><span class="va">States</span>, connect<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nb_islands</span><span class="op">)</span> <span class="co">#note that "7 regions with no links"</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 56 </span></span>
<span><span class="co">## Number of nonzero links: 224 </span></span>
<span><span class="co">## Percentage nonzero weights: 7.142857 </span></span>
<span><span class="co">## Average number of links: 4 </span></span>
<span><span class="co">## 7 regions with no links:</span></span>
<span><span class="co">## 1 2 17 19 20 33 50</span></span>
<span><span class="co">## Link number distribution:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  0  1  2  3  4  5  6  7  8 </span></span>
<span><span class="co">##  7  1  4  9  9 10 12  2  2 </span></span>
<span><span class="co">## 1 least connected region:</span></span>
<span><span class="co">## 52 with 1 link</span></span>
<span><span class="co">## 2 most connected regions:</span></span>
<span><span class="co">## 12 36 with 8 links</span></span></code></pre>
<p><strong>Example: All locations linked</strong></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nb_coerced</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_neighbors.html">get_neighbors</a></span><span class="op">(</span><span class="va">States</span>, connect<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nb_coerced</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 56 </span></span>
<span><span class="co">## Number of nonzero links: 242 </span></span>
<span><span class="co">## Percentage nonzero weights: 7.716837 </span></span>
<span><span class="co">## Average number of links: 4.321429 </span></span>
<span><span class="co">## Link number distribution:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  1  2  3  4  5  6  7  8 </span></span>
<span><span class="co">##  5  3 10 12 10 11  3  2 </span></span>
<span><span class="co">## 5 least connected regions:</span></span>
<span><span class="co">## 17 19 20 50 52 with 1 link</span></span>
<span><span class="co">## 2 most connected regions:</span></span>
<span><span class="co">## 12 36 with 8 links</span></span></code></pre>
<p><strong>View mapped adjacency</strong><br>
The <em>plot_neighbors()</em> function overlays adjacency connections on
mapped location boundaries.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_neighbors.html">plot_neighbors</a></span><span class="op">(</span><span class="va">States</span>, <span class="va">nb_islands</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Regions defined for each Polygons</span></span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_neighbors.html">plot_neighbors</a></span><span class="op">(</span><span class="va">States</span>, <span class="va">nb_coerced</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Regions defined for each Polygons</span></span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p><strong>Convert to INLA Graph</strong> The <em>nb2INLA()</em> and
<em>inla.read.graph()</em> functions are provided by the
<strong>INLA</strong> package.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2INLA.html" class="external-link">nb2INLA</a></span><span class="op">(</span><span class="st">"J"</span>, <span class="va">nb_coerced</span><span class="op">)</span></span>
<span><span class="va">J</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/read.graph.html" class="external-link">inla.read.graph</a></span><span class="op">(</span><span class="st">"J"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="retrieve-observation-data">Retrieve Observation Data<a class="anchor" aria-label="anchor" href="#retrieve-observation-data"></a>
</h2>
<p>The <em>get_covid19_obs()</em> function downloads hospital incidence
data for a specified data range.</p>
<div class="section level5">
<h5 id="the-source-options-for-data-to-be-retrieved">The <em>source</em> options for data to be retrieved:<a class="anchor" aria-label="anchor" href="#the-source-options-for-data-to-be-retrieved"></a>
</h5>
<ul>
<li>The <strong>covidcast</strong> package<br>
</li>
<li>From a local <em>cache</em> as created by the
<strong>covid19Forecasts</strong> package (i.e., refactored pipeline
pkg)<br>
</li>
<li>From <em>test</em> data available from the package itself (sample
from summer 2021)</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MinDate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">su_yaml</span><span class="op">$</span><span class="va">full_time_span</span><span class="op">)</span></span>
<span><span class="va">MaxDate</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">su_yaml</span><span class="op">$</span><span class="va">full_time_span</span><span class="op">)</span></span>
<span></span>
<span><span class="va">testData</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_covid19_obs.html">get_covid19_obs</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"covidcast"</span>, </span>
<span>                           start_date <span class="op">=</span> <span class="va">MinDate</span>, end_date <span class="op">=</span> <span class="va">MaxDate</span>, </span>
<span>                           write_copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#testData = get_covid19_obs(source = "cache", start_date = MinDate, end_date = MaxDate)</span></span>
<span><span class="co">#testData = get_covid19_obs(source = "test", start_date = MinDate, end_date = MaxDate)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">testData</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 4534    5</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">testData</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         date value signal location location_name</span></span>
<span><span class="co">## 1 2021-06-28     2   hosp       02        Alaska</span></span>
<span><span class="co">## 2 2021-06-28    29   hosp       01       Alabama</span></span>
<span><span class="co">## 3 2021-06-28    55   hosp       05      Arkansas</span></span>
<span><span class="co">## 4 2021-06-28    75   hosp       04       Arizona</span></span>
<span><span class="co">## 5 2021-06-28   201   hosp       06    California</span></span>
<span><span class="co">## 6 2021-06-28    60   hosp       08      Colorado</span></span></code></pre>
<p><strong>Add Spatial Index</strong><br>
The <em>append_region_index()</em> function matches location names in
the observation data to the <em>Region</em> index in the polygon
boundaries object, which also corresponds with the adjaceny matrix. The
Region index is added as a column to the observations as is a new
<strong>trn_tst</strong> column that is coded with either a
<strong>trn</strong> or <strong>tst</strong> nominal indicator to
distinguish time periods used for model training (observed) and testing
(not observed).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/append_region_index.html">append_region_index</a></span><span class="op">(</span>train_data <span class="op">=</span> <span class="va">testData</span>, polys <span class="op">=</span> <span class="va">States</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">$</span><span class="va">Region</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## integer(0)</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="forecast-template">Forecast Template<a class="anchor" aria-label="anchor" href="#forecast-template"></a>
</h2>
<p>The <em>create_forecast_template()</em> function ensures that each
location-time combination in the analysis is represented in the data
ingested by the model. In the case of model runs using only historic
observations, this function basically returns the original input but
with some column names adjusted. This because the full date range was
already represented. However, in the case of future dates where
observations are not yet available, this function will add a row for
each day through the forecast horizon coding the observed incidence
<em>value</em> as NA as a placeholder.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/create_forecast_template.html">create_forecast_template</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="additional-covariates">Additional Covariates<a class="anchor" aria-label="anchor" href="#additional-covariates"></a>
</h2>
<p>Demo models in this example are fairly simple but in many cases users
will want to add additional predictors, signals, or covariates
(independent variables). This section of the script demonstrates how to
(1) pull and add demographic variables from the American Community
Survey (ACS) and how to (2) add Rt estimates generated from the
<strong>EpiEstim</strong> package.</p>
<div class="section level3">
<h3 id="demographic-data">Demographic Data<a class="anchor" aria-label="anchor" href="#demographic-data"></a>
</h3>
<p>The <em>getPovertyPop()</em> function provides a wrapper function for
the <a href="https://centeronbudget.github.io/getcensus/" class="external-link"><strong>getCensus</strong>
package</a> for loading American Community Survey (ACS) data from the
U.S. Census Bureau. In this example, an API key (‘secret_api’) is used
to pull the percent of each state’s total population in poverty
(SAEPOVRTALL_PT) and the number of individuals over the age of 55yrs
(given in the <em>vars_pop</em> option).</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PovPop_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/getPovertyPop.html">getPovertyPop</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="../reference/get_api.html">get_api</a></span><span class="op">(</span><span class="st">"censusapi"</span><span class="op">)</span>, <span class="co">#function reads 'secrets.yaml' for specified name</span></span>
<span>                            vars_pov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SAEPOVRTALL_PT"</span><span class="op">)</span>, </span>
<span>                            vars_pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'AGEGROUP'</span>,<span class="st">'POP'</span><span class="op">)</span>, </span>
<span>                            filt_age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12</span>,<span class="fl">18</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">train_data</span>, <span class="va">PovPop_data</span>, by <span class="op">=</span> <span class="st">"location"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rt-estimation">Rt Estimation<a class="anchor" aria-label="anchor" href="#rt-estimation"></a>
</h3>
<p>The <em>Rt_projection()</em> function combines the
<em>estimate_R()</em> function from the <a href="https://github.com/mrc-ide/EpiEstim" class="external-link"><strong>EpiEstim</strong>
package</a> with simple timeseries models to forecast Rt estimated over
the model training period across the forecast horizon (28 days in the
future). Both the ‘raw’ Rt estimate (‘Rt_raw’) for the observation
period only and the forecast values (‘Rt’) are added to the
dataframe.</p>
<div class="section level5">
<h5 id="forecast-models-include">Forecast models include:<a class="anchor" aria-label="anchor" href="#forecast-models-include"></a>
</h5>
<ul>
<li>simple ARIMA model using the <strong>forecast</strong> package
(method=“arima”)<br>
</li>
<li>an order-2 random walk with noise and trend using the
<strong>INLA</strong> package (method=“dlm)</li>
</ul>
<p>NOTE: This is an experimental function and the “dlm” method is used
as an example. Models later in this demo will use the Rt_raw value to
forecast concurrently with incidence estimation.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rt_df</span> <span class="op">=</span> <span class="fu"><a href="../reference/Rt_projection.html">Rt_projection</a></span><span class="op">(</span><span class="va">train_data</span>, mean_si <span class="op">=</span> <span class="fl">5.7</span>, std_si <span class="op">=</span> <span class="fl">2</span>, </span>
<span>                      forecast_horizon <span class="op">=</span> <span class="fl">28</span>, method <span class="op">=</span> <span class="st">"dlm"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Rt Estimates</strong><br>
Checking <em>Rt_projection()</em> results</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rt_df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span> <span class="co">#check values</span></span></code></pre></div>
<pre><code><span><span class="co">##          date value signal location location_name       day trn_tst Region</span></span>
<span><span class="co">## 1  2021-06-28     2   hosp       02        Alaska    Monday   train     20</span></span>
<span><span class="co">## 2  2021-06-29     5   hosp       02        Alaska   Tuesday   train     20</span></span>
<span><span class="co">## 3  2021-06-30     2   hosp       02        Alaska Wednesday   train     20</span></span>
<span><span class="co">## 4  2021-07-01     6   hosp       02        Alaska  Thursday   train     20</span></span>
<span><span class="co">## 5  2021-07-02     3   hosp       02        Alaska    Friday   train     20</span></span>
<span><span class="co">## 6  2021-07-03     7   hosp       02        Alaska  Saturday   train     20</span></span>
<span><span class="co">## 7  2021-07-04     3   hosp       02        Alaska    Sunday   train     20</span></span>
<span><span class="co">## 8  2021-07-05     2   hosp       02        Alaska    Monday   train     20</span></span>
<span><span class="co">## 9  2021-07-06     5   hosp       02        Alaska   Tuesday   train     20</span></span>
<span><span class="co">## 10 2021-07-07     4   hosp       02        Alaska Wednesday   train     20</span></span>
<span><span class="co">##    SAEPOVRTALL_PT age_pop   Rt_raw       Rt</span></span>
<span><span class="co">## 1             9.6  184927       NA       NA</span></span>
<span><span class="co">## 2             9.6  184927       NA       NA</span></span>
<span><span class="co">## 3             9.6  184927       NA       NA</span></span>
<span><span class="co">## 4             9.6  184927       NA       NA</span></span>
<span><span class="co">## 5             9.6  184927       NA       NA</span></span>
<span><span class="co">## 6             9.6  184927       NA       NA</span></span>
<span><span class="co">## 7             9.6  184927       NA       NA</span></span>
<span><span class="co">## 8             9.6  184927 3.295300 3.272158</span></span>
<span><span class="co">## 9             9.6  184927 2.304267 2.334909</span></span>
<span><span class="co">## 10            9.6  184927 1.858476 1.848646</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Rt_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trn_tst</span> <span class="op">==</span> <span class="st">"test"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="co">#check values (forecast period)</span></span></code></pre></div>
<pre><code><span><span class="co">##          date value signal location location_name       day trn_tst Region</span></span>
<span><span class="co">## 1  2021-08-24    15   hosp       02        Alaska   Tuesday    test     20</span></span>
<span><span class="co">## 2  2021-08-25    33   hosp       02        Alaska Wednesday    test     20</span></span>
<span><span class="co">## 3  2021-08-26    18   hosp       02        Alaska  Thursday    test     20</span></span>
<span><span class="co">## 4  2021-08-27    21   hosp       02        Alaska    Friday    test     20</span></span>
<span><span class="co">## 5  2021-08-28    14   hosp       02        Alaska  Saturday    test     20</span></span>
<span><span class="co">## 6  2021-08-29    19   hosp       02        Alaska    Sunday    test     20</span></span>
<span><span class="co">## 7  2021-08-30    32   hosp       02        Alaska    Monday    test     20</span></span>
<span><span class="co">## 8  2021-08-31    22   hosp       02        Alaska   Tuesday    test     20</span></span>
<span><span class="co">## 9  2021-09-01    22   hosp       02        Alaska Wednesday    test     20</span></span>
<span><span class="co">## 10 2021-09-02    23   hosp       02        Alaska  Thursday    test     20</span></span>
<span><span class="co">##    SAEPOVRTALL_PT age_pop Rt_raw       Rt</span></span>
<span><span class="co">## 1             9.6  184927     NA 1.018212</span></span>
<span><span class="co">## 2             9.6  184927     NA 1.051603</span></span>
<span><span class="co">## 3             9.6  184927     NA 1.084992</span></span>
<span><span class="co">## 4             9.6  184927     NA 1.118382</span></span>
<span><span class="co">## 5             9.6  184927     NA 1.151771</span></span>
<span><span class="co">## 6             9.6  184927     NA 1.185161</span></span>
<span><span class="co">## 7             9.6  184927     NA 1.218551</span></span>
<span><span class="co">## 8             9.6  184927     NA 1.251941</span></span>
<span><span class="co">## 9             9.6  184927     NA 1.285331</span></span>
<span><span class="co">## 10            9.6  184927     NA 1.318721</span></span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="organize-data">Organize Data<a class="anchor" aria-label="anchor" href="#organize-data"></a>
</h2>
<p>Model parameters, inputs, and covariates will vary from
model-to-model and user-to-user but ultimately all need to be combined
in a single object that can be ingested by the the inference software,
INLA in this case. The code below modifies the train_data dataframe to
perform any desired scaling and to add several spatial and temporal
indices.</p>
<p>Ordered integers are used as indices to define timesteps (days,
weeks, etc), locations (‘Region’), and space*time combinations (e.g.,
‘ID.Region.Wk’ in the next chunk). The modeling approach is
hierarchical, so some indices may be used in multiple levels. But, each
index name must be unique therefore some indices are copied and given
slighly different names.</p>
<p>Once data is organized, it is reformatted as a list object called a
‘datastack’ that is passed to the inference software. Although a
daraframe might be more intuitive, a list object is used so that model
inputs can be of different lengths.</p>
<div class="section level3">
<h3 id="clean-dataframe">Clean Dataframe<a class="anchor" aria-label="anchor" href="#clean-dataframe"></a>
</h3>
<p>The <em>time_index()</em> function is used to recode a date vector to
the desired timestep duration (2-day steps, 1 week steps, etc).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">Rt_df</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    s_pop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">age_pop</span><span class="op">)</span>, <span class="co">#log scale</span></span>
<span>    s_pov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">SAEPOVRTALL_PT</span><span class="op">)</span><span class="op">)</span>, <span class="co">#some NAs present.  </span></span>
<span>    doy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    doy.1 <span class="op">=</span> <span class="va">doy</span>,</span>
<span>    Region.Wk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"ID"</span>, <span class="va">Region</span>, <span class="st">"W"</span>, <span class="va">doy</span><span class="op">)</span>, <span class="co">#unique Region*doy combinations ('space-time interaction')</span></span>
<span>    ID.Region.Wk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">Region.Wk</span><span class="op">)</span><span class="op">)</span>, <span class="co">#convert factor levels to integer</span></span>
<span>    week <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html" class="external-link">week</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    int_week.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    int_week.2 <span class="op">=</span> <span class="va">int_week.1</span>,</span>
<span>    int_week.3 <span class="op">=</span> <span class="va">int_week.1</span>,</span>
<span>    threeday_indx <span class="op">=</span> <span class="fu"><a href="../reference/time_index.html">time_index</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"3 days"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    threeday_indx.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">threeday_indx</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    fourday_indx <span class="op">=</span> <span class="fu"><a href="../reference/time_index.html">time_index</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"4 days"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    fourday_indx.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">fourday_indx</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    fiveday_indx <span class="op">=</span> <span class="fu"><a href="../reference/time_index.html">time_index</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"5 days"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    fiveday_indx.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">fiveday_indx</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    eightday_indx <span class="op">=</span> <span class="fu"><a href="../reference/time_index.html">time_index</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"8 days"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    eightday_indx.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">eightday_indx</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    biweek_indx <span class="op">=</span> <span class="fu"><a href="../reference/time_index.html">time_index</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>, by <span class="op">=</span> <span class="st">"14 days"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    biweek_indx.1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">biweek_indx</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    Region.1 <span class="op">=</span> <span class="va">Region</span>, Region.2 <span class="op">=</span> <span class="va">Region</span>, Region.3 <span class="op">=</span> <span class="va">Region</span>, </span>
<span>                Region.4 <span class="op">=</span> <span class="va">Region</span>, Region.5 <span class="op">=</span> <span class="va">Region</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">biweek_indx</span>, <span class="va">threeday_indx</span>, <span class="va">fourday_indx</span>, <span class="va">fiveday_indx</span>, <span class="va">eightday_indx</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         date value signal location location_name       day trn_tst Region</span></span>
<span><span class="co">## 1 2021-06-28     2   hosp       02        Alaska    Monday   train     20</span></span>
<span><span class="co">## 2 2021-06-29     5   hosp       02        Alaska   Tuesday   train     20</span></span>
<span><span class="co">## 3 2021-06-30     2   hosp       02        Alaska Wednesday   train     20</span></span>
<span><span class="co">## 4 2021-07-01     6   hosp       02        Alaska  Thursday   train     20</span></span>
<span><span class="co">## 5 2021-07-02     3   hosp       02        Alaska    Friday   train     20</span></span>
<span><span class="co">## 6 2021-07-03     7   hosp       02        Alaska  Saturday   train     20</span></span>
<span><span class="co">##   SAEPOVRTALL_PT age_pop Rt_raw Rt    s_pop      s_pov doy doy.1 Region.Wk</span></span>
<span><span class="co">## 1            9.6  184927     NA NA 12.12772 -0.8064822   1     1    ID20W1</span></span>
<span><span class="co">## 2            9.6  184927     NA NA 12.12772 -0.8064822   2     2    ID20W2</span></span>
<span><span class="co">## 3            9.6  184927     NA NA 12.12772 -0.8064822   3     3    ID20W3</span></span>
<span><span class="co">## 4            9.6  184927     NA NA 12.12772 -0.8064822   4     4    ID20W4</span></span>
<span><span class="co">## 5            9.6  184927     NA NA 12.12772 -0.8064822   5     5    ID20W5</span></span>
<span><span class="co">## 6            9.6  184927     NA NA 12.12772 -0.8064822   6     6    ID20W6</span></span>
<span><span class="co">##   ID.Region.Wk week int_week.1 int_week.2 int_week.3 threeday_indx</span></span>
<span><span class="co">## 1          795   26          1          1          1    2021-06-28</span></span>
<span><span class="co">## 2          806   26          1          1          1    2021-06-28</span></span>
<span><span class="co">## 3          817   26          1          1          1    2021-07-01</span></span>
<span><span class="co">## 4          828   26          1          1          1    2021-07-01</span></span>
<span><span class="co">## 5          839   27          2          2          2    2021-07-01</span></span>
<span><span class="co">## 6          850   27          2          2          2    2021-07-04</span></span>
<span><span class="co">##   threeday_indx.1 fourday_indx fourday_indx.1 fiveday_indx fiveday_indx.1</span></span>
<span><span class="co">## 1               1   2021-06-28              1   2021-06-28              1</span></span>
<span><span class="co">## 2               1   2021-06-28              1   2021-06-28              1</span></span>
<span><span class="co">## 3               2   2021-06-28              1   2021-06-28              1</span></span>
<span><span class="co">## 4               2   2021-07-02              2   2021-07-03              2</span></span>
<span><span class="co">## 5               2   2021-07-02              2   2021-07-03              2</span></span>
<span><span class="co">## 6               3   2021-07-02              2   2021-07-03              2</span></span>
<span><span class="co">##   eightday_indx eightday_indx.1 biweek_indx.1 Region.1 Region.2 Region.3</span></span>
<span><span class="co">## 1    2021-06-28               1             1       20       20       20</span></span>
<span><span class="co">## 2    2021-06-28               1             1       20       20       20</span></span>
<span><span class="co">## 3    2021-06-28               1             1       20       20       20</span></span>
<span><span class="co">## 4    2021-06-28               1             1       20       20       20</span></span>
<span><span class="co">## 5    2021-06-28               1             1       20       20       20</span></span>
<span><span class="co">## 6    2021-07-06               2             1       20       20       20</span></span>
<span><span class="co">##   Region.4 Region.5</span></span>
<span><span class="co">## 1       20       20</span></span>
<span><span class="co">## 2       20       20</span></span>
<span><span class="co">## 3       20       20</span></span>
<span><span class="co">## 4       20       20</span></span>
<span><span class="co">## 5       20       20</span></span>
<span><span class="co">## 6       20       20</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="response-variable">Response Variable<a class="anchor" aria-label="anchor" href="#response-variable"></a>
</h3>
<p>The response variable may differ between models. In this case,
copying hospital incidence (counts) to a new column, standardizing the
distribution, and ensuring that observations for the forecast horizon
are coded as NA. Retaining the scaling object and rewriting as function
<em>obs_scale()</em> to transform model outputs back to the observation
scale later.</p>
<p>Again, response variables are specific to individual model setup so
could be scaled differently or not at all to be fit with a different
likelihood (Poisson, NegBinomial, etc). Keeping it simple here.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">train_data</span><span class="op">$</span><span class="va">resp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">$</span><span class="va">trn_tst</span> <span class="op">==</span> <span class="st">"train"</span>, <span class="va">train_data</span><span class="op">$</span><span class="va">value</span>, <span class="cn">NA</span><span class="op">)</span> <span class="co">#Set obs value to NA for forecasts periods</span></span>
<span></span>
<span><span class="va">resp_scale_obj</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">$</span><span class="va">resp</span>, scale<span class="op">=</span><span class="cn">T</span>, center<span class="op">=</span><span class="cn">T</span><span class="op">)</span> <span class="co">#scaled object</span></span>
<span><span class="va">obs_scale</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="va">r</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">resp_scale_obj</span>,<span class="st">'scaled:scale'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">resp_scale_obj</span>, <span class="st">'scaled:center'</span><span class="op">)</span> <span class="co">#transform back to observation scale</span></span>
<span></span>
<span><span class="va">train_data</span><span class="op">$</span><span class="va">nrm_resp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">resp_scale_obj</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="format-as-a-datastack">Format as a Datastack<a class="anchor" aria-label="anchor" href="#format-as-a-datastack"></a>
</h3>
<p>In this example, data could remain as a dataframe and passed to INLA
directly, but as a matter of practice, it is better to format as a list
object (datastack).</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nrm.lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>intercept1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, <span class="co">#custom intercept</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pov_pct <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"s_pov"</span><span class="op">]</span>,                <span class="co">#desired covariates and indices below</span></span>
<span>               pop <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"s_pop"</span><span class="op">]</span>,                    <span class="co">#formatting as nrm.lst = list()</span></span>
<span>               Rt_raw <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Rt_raw"</span><span class="op">]</span>,</span>
<span>               Rt_raw.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Rt_raw"</span><span class="op">]</span>,</span>
<span>               Rt <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Rt"</span><span class="op">]</span>,</span>
<span>               Rt.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Rt"</span><span class="op">]</span>,</span>
<span>               doy <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"doy"</span><span class="op">]</span>,</span>
<span>               doy.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"doy.1"</span><span class="op">]</span>,</span>
<span>               doy.2 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"doy.1"</span><span class="op">]</span>,</span>
<span>               int_week.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"int_week.1"</span><span class="op">]</span>,</span>
<span>               int_week.2 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"int_week.2"</span><span class="op">]</span>,</span>
<span>               int_week.3 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"int_week.3"</span><span class="op">]</span>,</span>
<span>               threeday_indx.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"threeday_indx.1"</span><span class="op">]</span>,</span>
<span>               fourday_indx.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"fourday_indx.1"</span><span class="op">]</span>,</span>
<span>               fiveday_indx.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"fiveday_indx.1"</span><span class="op">]</span>,</span>
<span>               eightday_indx.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"eightday_indx.1"</span><span class="op">]</span>,</span>
<span>               biwek_indx.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"biweek_indx.1"</span><span class="op">]</span>,</span>
<span>               Region.1 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Region.1"</span><span class="op">]</span>,</span>
<span>               Region.2 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Region.2"</span><span class="op">]</span>,</span>
<span>               Region.3 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Region.3"</span><span class="op">]</span>,</span>
<span>               Region.4 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Region.4"</span><span class="op">]</span>,</span>
<span>               Region.5 <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"Region.5"</span><span class="op">]</span>,</span>
<span>               Region_Wk <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"ID.Region.Wk"</span><span class="op">]</span>,</span>
<span>               dow <span class="op">=</span> <span class="va">train_data</span><span class="op">[</span>,<span class="st">"day"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nrm.stk</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">train_data</span><span class="op">$</span><span class="va">nrm_resp</span><span class="op">)</span>, <span class="co">#Y is response variable</span></span>
<span>                                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>,       <span class="co">#option to include matrices, not used in this case</span></span>
<span>                                effects <span class="op">=</span> <span class="va">nrm.lst</span>,         <span class="co">#list object from above</span></span>
<span>                                    tag <span class="op">=</span> <span class="st">"nrm"</span><span class="op">)</span>           <span class="co">#arbitrary name to index searches later </span></span>
<span>                                                           <span class="co">#(multiple datastack used in complex models)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="model-priors-and-formulae">Model Priors and Formulae<a class="anchor" aria-label="anchor" href="#model-priors-and-formulae"></a>
</h2>
<p>Specifying all priors and formulas for desired models using <a href="https://www.r-inla.org/" class="external-link"><strong>R-INLA</strong></a> syntax. A
deep-dive would be needed to describe in detail, which would be too time
consuming for this workflow focused demonstration.</p>
<div class="section level4">
<h4 id="a-few-notes">A few notes:<a class="anchor" aria-label="anchor" href="#a-few-notes"></a>
</h4>
<ul>
<li>Priors
<ul>
<li>
<strong>pc</strong> refers to <a href="https://doi.org/10.1214/16-STS576" class="external-link">“Penalizing
Complexity”</a>
</li>
<li>
<strong>prec</strong> is “precision”<br>
</li>
<li>
<strong>cor</strong> is “correlation”<br>
</li>
<li>non-PC priors are coded using the distribution name (e.g., norm =
“normal”)<br>
</li>
</ul>
</li>
<li>Formulas
<ul>
<li>
<strong>Y</strong> is the response variable in the datastack</li>
<li>
<em>f()</em> designates a function, level, or submodel in the
hierarchy<br>
</li>
<li>
<strong>hyper=</strong> refers to the prior for that
<em>f()</em>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="set-priors">Set Priors<a class="anchor" aria-label="anchor" href="#set-priors"></a>
</h3>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#bym prior</span></span>
<span><span class="va">bym_hyper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>phi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"pc"</span>, </span>
<span>                      param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">2</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span>, </span>
<span>                      initial <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, </span>
<span>               prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"pc.prec"</span>, </span>
<span>                       param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.01</span><span class="op">)</span>, </span>
<span>                       initial <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">)</span>  </span>
<span><span class="co">#Normal prior</span></span>
<span><span class="va">norm.prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">"normal"</span>, </span>
<span>                              param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#iid prior</span></span>
<span><span class="va">pc_prec_iid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior<span class="op">=</span><span class="st">"pc.prec"</span>, </span>
<span>                                 param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#ar1 prior</span></span>
<span><span class="va">pc_cor_ar1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior <span class="op">=</span> <span class="st">'pccor1'</span>, </span>
<span>                                param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#rw2 prior</span></span>
<span><span class="va">pc_rw2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prior<span class="op">=</span><span class="st">"pc.prec"</span>, </span>
<span>                         param<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.01</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#bundle priors to archive run</span></span>
<span><span class="va">priors.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">priors.list</span><span class="op">[[</span><span class="st">"bym_hyper"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bym_hyper</span></span>
<span><span class="va">priors.list</span><span class="op">[[</span><span class="st">"norm.prior"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">norm.prior</span></span>
<span><span class="va">priors.list</span><span class="op">[[</span><span class="st">"pc_prec_iid"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pc_prec_iid</span></span>
<span><span class="va">priors.list</span><span class="op">[[</span><span class="st">"pc_cor_ar1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pc_cor_ar1</span></span>
<span><span class="va">priors.list</span><span class="op">[[</span><span class="st">"pc_rw2"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pc_rw2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="specify-formulas">Specify Formulas<a class="anchor" aria-label="anchor" href="#specify-formulas"></a>
</h3>
<p><strong>Formula 1:</strong> Random Walk plus noise for each location
(i.e., state)</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.1</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>     <span class="co">#remove default intercept</span></span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       <span class="co">#custom intercept</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,           <span class="co">#order by time index (daily)</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     <span class="co">#enforced zero mean</span></span>
<span>    model<span class="op">=</span><span class="st">"rw1"</span>,     <span class="co">#order-1 random walk with noise</span></span>
<span>    scale.model <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">#additional internal scaling</span></span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>, <span class="co">#run rw1 model for groups based on location </span></span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, <span class="co">#groups are treated independently</span></span>
<span>    hyper<span class="op">=</span><span class="va">pc_rw2</span><span class="op">)</span>  <span class="co">#prior for rw2</span></span></code></pre></div>
<p><strong>Formula 2:</strong> Random Walk plus noise and trend for each
location</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.2</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>     </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,           </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     </span>
<span>    model<span class="op">=</span><span class="st">"rw1"</span>,    </span>
<span>    scale.model <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_rw2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.2</span>, model<span class="op">=</span><span class="st">"linear"</span>, mean.linear <span class="op">=</span> <span class="fl">0</span>, prec.linear <span class="op">=</span> <span class="fl">0.001</span><span class="op">)</span> <span class="co">#add linear trend to rw1</span></span></code></pre></div>
<p><strong>Formula 3:</strong> Common spatial effect for timesteps but
each location has separate autoregression</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.3</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>    </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        <span class="co">#location index</span></span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,    <span class="co">#spatial effect, Besag-York-Mollie model (the 2 indicates scaling) </span></span>
<span>    graph<span class="op">=</span><span class="va">J</span>,         <span class="co">#Adjacency graph to identify neighbors</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     <span class="co">#enforced zero mean</span></span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span><span class="op">)</span> <span class="op">+</span> <span class="co">#BYM prior</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,             <span class="co">#order by time index (daily)</span></span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,       <span class="co">#apply order-1 autoregressive</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>,  <span class="co">#run ar1 model for groups based on location</span></span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, <span class="co">#groups are treated independently</span></span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Formula 4:</strong> Separate spatial effect for each timestep
(related by ar1) and each location has its own autoregressive term.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.4</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>     </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        </span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,   </span>
<span>    graph<span class="op">=</span><span class="va">J</span>,         </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     </span>
<span>    group <span class="op">=</span> <span class="va">doy</span>,     <span class="co">#time index, daily (create separate realizations of spatial covariate for each day)</span></span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"ar1"</span><span class="op">)</span>, <span class="co">#groups are related via an order-1 autoregressive</span></span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span><span class="op">)</span> <span class="op">+</span> <span class="co">#prior for BYM</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,             </span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,       </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>,  </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Formula 5:</strong> As Formula 4 but with space-time
interaction to capture location and time specific variation outside of
modeled trends.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.5</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>    </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        </span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,    </span>
<span>    graph<span class="op">=</span><span class="va">J</span>,         </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,    </span>
<span>    group <span class="op">=</span> <span class="va">doy</span>,     </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"ar1"</span><span class="op">)</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,             </span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,       </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>,  </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region_Wk</span>,   <span class="co">#Index for all location*time combinations (space-time interaction)</span></span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>, <span class="co">#each location and time combination considered independently</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Formula 6:</strong> As Formula 5 but adding covariate for
variation due to day of week (e.g. Monday, Tuesday,…Sunday).</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.6</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>    </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        </span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,    </span>
<span>    graph<span class="op">=</span><span class="va">J</span>,         </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     </span>
<span>    group <span class="op">=</span> <span class="va">doy</span>,     </span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"ar1"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>,             </span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,       </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.1</span>,  </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">dow</span>,           <span class="co">#discrete variable indicating day of week, e.g. Monday, Tuesday,...Sunday</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>,   <span class="co">#days of week may vary independently</span></span>
<span>    group <span class="op">=</span> <span class="va">Region.2</span>, <span class="co">#variation attributed to days of week may differ by location</span></span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region_Wk</span>,   </span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>, </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Formula 7:</strong> Including Rt estimates as an experimental
covariate. Forecast Rt trend estimated from the observation period
(training period) to the future (28 days) using an autoregressive
model.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.7</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>     </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="va">pov_pct</span> <span class="op">+</span> <span class="va">pop</span> <span class="op">+</span>    </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        </span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,    </span>
<span>    graph<span class="op">=</span><span class="va">J</span>,        </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     </span>
<span>    group <span class="op">=</span> <span class="va">doy</span>,     </span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"ar1"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>, <span class="va">Rt_raw</span>,  <span class="co">#order by time index (daily) but weight each timestep by corresponding Rt_raw estimate</span></span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,    <span class="co">#apply order-1 autoregressive to Rt weighted time index above</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.2</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">dow</span>,           </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.3</span>,</span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region_Wk</span>,   </span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>, </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Formula 8:</strong> As with Formula 8 but adding a random
walk at a more coarse time scale (3 day steps) to reduce forecast
decay.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Frm.8</span> <span class="op">=</span> <span class="va">Y</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span>     </span>
<span>  <span class="va">intercept1</span> <span class="op">+</span>       </span>
<span>  <span class="va">pov_pct</span> <span class="op">+</span> <span class="va">pop</span> <span class="op">+</span>    <span class="co">#linear covariates for poverty and population over 55yrs</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region.1</span>,        </span>
<span>    model<span class="op">=</span><span class="st">"bym2"</span>,    </span>
<span>    graph<span class="op">=</span><span class="va">J</span>,        </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,     </span>
<span>    group <span class="op">=</span> <span class="va">doy</span>,    </span>
<span>    hyper<span class="op">=</span><span class="va">bym_hyper</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"ar1"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">threeday_indx.1</span>, <span class="co">#time index, 3days</span></span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    model<span class="op">=</span><span class="st">"rw2"</span>,     <span class="co">#order-2 random walk with noise</span></span>
<span>    scale.model <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.2</span>,</span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>, </span>
<span>    hyper<span class="op">=</span><span class="va">pc_rw2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">doy.1</span>, <span class="va">Rt_raw</span>,  </span>
<span>    model<span class="op">=</span><span class="st">"ar1"</span>,    </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.3</span>, </span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_cor_ar1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">dow</span>,           </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>,</span>
<span>    group <span class="op">=</span> <span class="va">Region.4</span>,</span>
<span>    control.group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"iid"</span><span class="op">)</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">Region_Wk</span>,   </span>
<span>    model<span class="op">=</span><span class="st">"iid"</span>, </span>
<span>    constr<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    hyper<span class="op">=</span><span class="va">pc_prec_iid</span><span class="op">)</span> </span></code></pre></div>
<p><strong>Organize Formulas</strong></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formulas.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"base_rw1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.1</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"rw1_trend"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.2</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"base_car"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.3</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"car_time"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.4</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"car_sti"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.5</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"car_wdays"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.6</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"car_rt"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.7</span></span>
<span><span class="va">formulas.list</span><span class="op">[[</span><span class="st">"car_full"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">Frm.8</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="run-models">Run Models<a class="anchor" aria-label="anchor" href="#run-models"></a>
</h2>
<p>The <em>run_model_list()</em> function runs a series of models as
specified in the <strong>formulas.list</strong> using the input data
organized as a datastack (nrm.srk). The function runs each model
sequentially and writes the executed models (models_out), formulas
(formulas.list), priors (prior.list), datastack, and original dataframe
(train_data) to an <strong>.RData</strong> in the analysis directory.
The <strong>models_out</strong> object will also be available in the
environment for further processing.</p>
<p>There are many customization options for inference but have opted to
keep <em>run_model_list()</em> fairly simple for ease of use and maximum
efficiency.</p>
<div class="section level5">
<h5 id="addional-run_model_list-options">Addional <em>run_model_list()</em> options:<a class="anchor" aria-label="anchor" href="#addional-run_model_list-options"></a>
</h5>
<ul>
<li>
<strong>likelihood</strong>
<ul>
<li>If one likelihood is provided it will be applied to all models<br>
</li>
<li>A vector of likelihoods can be provided with order based on
<strong>formulas.list</strong><br>
</li>
<li>e.g., myFamilies &lt;- c(“gaussian”, “binomial”,
“zeroinflatednbinomial”, …)</li>
</ul>
</li>
<li>
<strong>config</strong>
<ul>
<li>indicates if latencies (GMRF) should be retained for sampling<br>
</li>
<li>
<strong>config=TRUE</strong> can be time intensive and dramatically
slow model runs</li>
<li>CovidCAR has a <em>post_sampling()</em> function to facilitate
sampling</li>
</ul>
</li>
<li>
<strong>verbose</strong> prints INLA algorithm process to screen
during model runs<br>
</li>
<li>
<strong>archive</strong> indicates to save model inputs and results
to the analysis directory
<ul>
<li>model outputs will be written to a <em>run_archive</em>
subdirectory</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="run-all-models">Run All Models<a class="anchor" aria-label="anchor" href="#run-all-models"></a>
</h3>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#formulas.list = formulas.list[c(1:4)] #short list for demo, fast run models</span></span>
<span></span>
<span><span class="va">models_out</span> <span class="op">=</span> <span class="fu"><a href="../reference/run_model_list.html">run_model_list</a></span><span class="op">(</span>formulas.list<span class="op">=</span><span class="va">formulas.list</span>,</span>
<span>                            dataStack<span class="op">=</span><span class="va">nrm.stk</span>,</span>
<span>                            likelihood <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>                            config<span class="op">=</span><span class="cn">FALSE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span>, archive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="extract-and-format-forecasts">Extract and Format Forecasts<a class="anchor" aria-label="anchor" href="#extract-and-format-forecasts"></a>
</h2>
<p>The <em>extract_forecasts()</em> function pulls forecasts from models
and saves them to a <em>forecasts</em> folder in analysis directory. The
function returns a <em>forecast_paths</em> list object to the
environment with file path names.</p>
<p>Forecasts are formatted to the specifications required for submission
to the <a href="https://github.com/reichlab/covid19-forecast-hub" class="external-link">covid19-forecast-hub</a>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extract_forecasts.html">extract_forecasts</a></span><span class="op">(</span>mod_out<span class="op">=</span><span class="va">models_out</span>,</span>
<span>                  dataStack<span class="op">=</span><span class="va">nrm.stk</span>, train_data<span class="op">=</span><span class="va">train_data</span>,</span>
<span>                  team <span class="op">=</span> <span class="st">"CFA"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m base_rw1  [38;5;249m[1.8s] [39m                                
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m rw1_trend  [38;5;249m[2.4s] [39m                               
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m base_car  [38;5;249m[2.3s] [39m                                
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m car_time  [38;5;249m[2.2s] [39m                                
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m car_sti  [38;5;249m[2.4s] [39m                                 
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m car_wdays  [38;5;249m[2.1s] [39m                               
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m car_rt  [38;5;249m[2.8s] [39m                                  
## 
 [36mℹ [39m Writing model forecasts to analysis directory: 

 [32m✔ [39m car_full  [38;5;249m[2.5s] [39m                                </code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#check returned object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">forecast_paths</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "base_rw1"  "rw1_trend" "base_car"  "car_time"  "car_sti"   "car_wdays"</span></span>
<span><span class="co">## [7] "car_rt"    "car_full"</span></span></code></pre>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">forecast_paths</span><span class="op">[[</span><span class="st">"rw1_trend"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co">#formatted for submission</span></span></code></pre></div>
<pre><code><span><span class="co">##   forecast_date location               target target_end_date     type quantile</span></span>
<span><span class="co">## 1    2021-08-23       02 0 day ahead inc hosp      2021-08-23 quantile     0.01</span></span>
<span><span class="co">## 2    2021-08-23       02 1 day ahead inc hosp      2021-08-24 quantile     0.01</span></span>
<span><span class="co">## 3    2021-08-23       02 2 day ahead inc hosp      2021-08-25 quantile     0.01</span></span>
<span><span class="co">## 4    2021-08-23       02 3 day ahead inc hosp      2021-08-26 quantile     0.01</span></span>
<span><span class="co">## 5    2021-08-23       02 4 day ahead inc hosp      2021-08-27 quantile     0.01</span></span>
<span><span class="co">## 6    2021-08-23       02 5 day ahead inc hosp      2021-08-28 quantile     0.01</span></span>
<span><span class="co">##      value</span></span>
<span><span class="co">## 1 18.04242</span></span>
<span><span class="co">## 2  0.00000</span></span>
<span><span class="co">## 3  0.00000</span></span>
<span><span class="co">## 4 15.69182</span></span>
<span><span class="co">## 5 47.97946</span></span>
<span><span class="co">## 6 83.44678</span></span></code></pre>
<p><strong>View forecasts</strong> <em>extract_forecasts()</em> also
returns a list (‘plot_paths’) of paths to plotting data from the
extraction process. This data can be accessed from the
<em>plot_location()</em> function, which provides a quick diagnostic
plot of forecast for a specific location.</p>
<p>Note of Caution: If the ‘loc=’ option is left as NULL, all locations
will be plotted to PDF file and saved in the ‘Reports’ folder of the
analysis directory. This may be time consuming!</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">OK_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_location.html">plot_location</a></span><span class="op">(</span>plot_path <span class="op">=</span> <span class="va">plot_paths</span>, model <span class="op">=</span> <span class="st">"car_full"</span>, loc <span class="op">=</span> <span class="st">"Oklahoma"</span><span class="op">)</span></span>
<span><span class="va">OK_plot</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">AR_plot</span> <span class="op">=</span> <span class="fu"><a href="../reference/plot_location.html">plot_location</a></span><span class="op">(</span>plot_path <span class="op">=</span> <span class="va">plot_paths</span>, model <span class="op">=</span> <span class="st">"car_full"</span>, loc <span class="op">=</span> <span class="st">"Arkansas"</span><span class="op">)</span></span>
<span><span class="va">AR_plot</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-31-2.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#plot_location(plot_path = plot_paths, model = "car_full") #plots and saves all locations to a pdf file</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-scoring">Model Scoring<a class="anchor" aria-label="anchor" href="#model-scoring"></a>
</h2>
<div class="section level3">
<h3 id="wis-scores">WIS Scores<a class="anchor" aria-label="anchor" href="#wis-scores"></a>
</h3>
<p>The <em>score_WIS()</em> function calculates the WIS score for
forecasts by model. Optional arguments can be included to indicate if
files should be read from a directory (ingest = “path”), a dataframe in
the environment (ingest = “dataframe”),or from a list object with
individual file paths (ingest = “list”) as returned by
<em>extract_forecasts()</em>.</p>
<p>The ‘missing’ option can be used to specify how missing observation
data should be handled; ‘remove’ from data or fill with ‘zero’.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_truth</span> <span class="op">&lt;-</span> <span class="va">train_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co">#Caution: my_truth may be different than your truth :)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">location</span>, <span class="va">value</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score_WIS.html">score_WIS</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">forecast_paths</span>, truth<span class="op">=</span><span class="va">my_truth</span>, </span>
<span>                       ingest <span class="op">=</span> <span class="st">"list"</span>, missing <span class="op">=</span> <span class="st">"remove"</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## → A total of 5336 predictions weren't evalauted due lack of truth data</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">my_scores</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      model       date location_name forecast_date      WIS</span></span>
<span><span class="co">## 1 base_car 2021-08-23            01    2021-08-23 1.349751</span></span>
<span><span class="co">## 2 base_car 2021-08-23            02    2021-08-23 1.105233</span></span>
<span><span class="co">## 3 base_car 2021-08-23            04    2021-08-23 1.200149</span></span>
<span><span class="co">## 4 base_car 2021-08-23            05    2021-08-23 1.460301</span></span>
<span><span class="co">## 5 base_car 2021-08-23            06    2021-08-23 1.401860</span></span>
<span><span class="co">## 6 base_car 2021-08-23            08    2021-08-23 1.142202</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#overall</span></span>
<span><span class="va">wis_rank</span> <span class="op">&lt;-</span> <span class="va">my_scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_wis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">WIS</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">mean_wis</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wisRank <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">wis_rank</span> <span class="co">#mean absolute values</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 8 × 3</span></span></span>
<span><span class="co">##   model     mean_wis wisRank</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> car_wdays     33.5       1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> car_rt        34.1       2</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> base_car      34.6       3</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> car_time      34.6       4</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> car_sti       34.9       5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> car_full      49.3       6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">7</span> base_rw1     281.        7</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">8</span> rw1_trend    307.        8</span></span></code></pre>
<p><strong>Diagnostic score plots</strong><br>
The <em>plot_WIS_lines()</em> function has options to make quick plots
of WIS scores returned by <em>score_WIS()</em>.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">my_scores</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "base_car"  "base_rw1"  "car_full"  "car_rt"    "car_sti"   "car_time" </span></span>
<span><span class="co">## [7] "car_wdays" "rw1_trend"</span></span></code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#lines showing absolute WIS</span></span>
<span><span class="fu"><a href="../reference/plot_WIS_lines.html">plot_WIS_lines</a></span><span class="op">(</span><span class="va">my_scores</span>, by <span class="op">=</span> <span class="st">"date"</span>, range <span class="op">=</span> <span class="st">"abs"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-1.png" width="700"></p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#lines showing scaled WIS</span></span>
<span><span class="fu"><a href="../reference/plot_WIS_lines.html">plot_WIS_lines</a></span><span class="op">(</span><span class="va">my_scores</span>, by <span class="op">=</span> <span class="st">"date"</span>, range <span class="op">=</span> <span class="st">"scaled"</span>, </span>
<span>               scale_model <span class="op">=</span> <span class="st">"base_rw1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-2.png" width="700"></p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#optional 'limit' that recodes: (WIS &gt;= limit) -&gt; limit</span></span>
<span><span class="fu"><a href="../reference/plot_WIS_lines.html">plot_WIS_lines</a></span><span class="op">(</span><span class="va">my_scores</span>, by <span class="op">=</span> <span class="st">"date"</span>, range <span class="op">=</span> <span class="st">"scaled"</span>, </span>
<span>               scale_model <span class="op">=</span> <span class="st">"base_rw1"</span>, limit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-3.png" width="700"></p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#tile option</span></span>
<span><span class="fu"><a href="../reference/plot_WIS_lines.html">plot_WIS_lines</a></span><span class="op">(</span><span class="va">my_scores</span>, by <span class="op">=</span> <span class="st">"tile"</span>, range <span class="op">=</span> <span class="st">"scaled"</span>, </span>
<span>               scale_model <span class="op">=</span> <span class="st">"base_rw1"</span>, limit <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 864 rows containing missing values (`geom_tile()`).</span></span></code></pre>
<p><img src="introduction_files/figure-html/unnamed-chunk-33-4.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="mean-absolute-error-mae">Mean Absolute Error (MAE)<a class="anchor" aria-label="anchor" href="#mean-absolute-error-mae"></a>
</h3>
<p>The <em>score_MAE()</em> function works comparably to
<em>score_WIS()</em> but is a simpler measure of model performance as it
is based on only the point estimates from forecasts.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score_MAE.html">score_MAE</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">forecast_paths</span>, truth<span class="op">=</span><span class="va">my_truth</span>, ingest <span class="op">=</span> <span class="st">"list"</span>, missing <span class="op">=</span> <span class="st">"remove"</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## → A total of 232 forecasts weren't evaluatd due lack of truth data</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_mae</span></span></code></pre></div>
<pre><code><span><span class="co">##       model   MAE    MAPE maeRank</span></span>
<span><span class="co">## 1 car_wdays  41.4 0.01247       1</span></span>
<span><span class="co">## 2    car_rt  41.8 0.01262       2</span></span>
<span><span class="co">## 3  base_car  41.9 0.01262       3</span></span>
<span><span class="co">## 4  car_time  41.9 0.01263       4</span></span>
<span><span class="co">## 5   car_sti  42.1 0.01271       5</span></span>
<span><span class="co">## 6  car_full  62.8 0.01893       6</span></span>
<span><span class="co">## 7  base_rw1 325.6 0.09818       7</span></span>
<span><span class="co">## 8 rw1_trend 353.3 0.10652       8</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="ensemble">Ensemble<a class="anchor" aria-label="anchor" href="#ensemble"></a>
</h2>
<p>The <em>propose_weights()</em> function assists with ensemble
building by weighting models using a given performance metric. The
function scales the raw model comparison metric and then builds the
ensemble by multiplying each forecasts by its model-specific weight and
summing across all included models. The resulting ensemble forecast is
then standardized for Covid19-hub submission and written to the analysis
directory (./forecasts). The function returns the estimated weights to
the environment.</p>
<p>For example, the WIS and MAE scores could be used to weight
individual models in an ensemble.</p>
<p>First, compare WIS and MAE scores:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">my_mae</span>, <span class="va">wis_rank</span>, by<span class="op">=</span><span class="st">"model"</span><span class="op">)</span> <span class="co">#combine with overall WIS</span></span>
<span></span>
<span><span class="va">mod_rank</span> <span class="co">#note the scores rank models differently  </span></span></code></pre></div>
<pre><code><span><span class="co">##       model   MAE    MAPE maeRank  mean_wis wisRank</span></span>
<span><span class="co">## 1 car_wdays  41.4 0.01247       1  33.54621       1</span></span>
<span><span class="co">## 2    car_rt  41.8 0.01262       2  34.10622       2</span></span>
<span><span class="co">## 3  base_car  41.9 0.01262       3  34.57760       3</span></span>
<span><span class="co">## 4  car_time  41.9 0.01263       4  34.64150       4</span></span>
<span><span class="co">## 5   car_sti  42.1 0.01271       5  34.90884       5</span></span>
<span><span class="co">## 6  car_full  62.8 0.01893       6  49.25360       6</span></span>
<span><span class="co">## 7  base_rw1 325.6 0.09818       7 280.86031       7</span></span>
<span><span class="co">## 8 rw1_trend 353.3 0.10652       8 307.10326       8</span></span></code></pre>
<p>The <em>propose_weights()</em> function can the be applied to
generate weights and write the resulting ensemble.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_wis_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/propose_weights.html">propose_weights</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">forecast_paths</span>, <span class="co">#standardized model forecasts</span></span>
<span>                             ingest <span class="op">=</span> <span class="st">"list"</span>,                     <span class="co">#read model locations as list</span></span>
<span>                             rank_df <span class="op">=</span> <span class="va">mod_rank</span>,                  <span class="co">#use the data from WIS and MAE scoring         </span></span>
<span>                             rankCol <span class="op">=</span> <span class="st">"mean_wis"</span>,                <span class="co">#weight models based on this column</span></span>
<span>                             team <span class="op">=</span> <span class="st">"CFA"</span>,                        <span class="co">#team name (need be in file name per Covid19hub)</span></span>
<span>                             mod_name <span class="op">=</span> <span class="st">"wis_ensemble"</span><span class="op">)</span>           <span class="co">#label for the new ensemble forecast</span></span></code></pre></div>
<pre><code><span><span class="co">## → Writing ensemble 'wis_ensemble' to analysis directory</span></span></code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_wis_weights</span> <span class="co">#The weights column reports the actual weights calculated for each model</span></span></code></pre></div>
<pre><code><span><span class="co">##       model   MAE    MAPE maeRank  mean_wis wisRank mean_wis_weights</span></span>
<span><span class="co">## 1 car_wdays  41.4 0.01247       1  33.54621       1       0.13693337</span></span>
<span><span class="co">## 2    car_rt  41.8 0.01262       2  34.10622       2       0.13683448</span></span>
<span><span class="co">## 3  base_car  41.9 0.01262       3  34.57760       3       0.13675124</span></span>
<span><span class="co">## 4  car_time  41.9 0.01263       4  34.64150       4       0.13673996</span></span>
<span><span class="co">## 5   car_sti  42.1 0.01271       5  34.90884       5       0.13669275</span></span>
<span><span class="co">## 6  car_full  62.8 0.01893       6  49.25360       6       0.13415968</span></span>
<span><span class="co">## 7  base_rw1 325.6 0.09818       7 280.86031       7       0.09326132</span></span>
<span><span class="co">## 8 rw1_trend 353.3 0.10652       8 307.10326       8       0.08862720</span></span></code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#another example,this time using MAE and including a 'drop' option</span></span>
<span><span class="va">my_mae_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/propose_weights.html">propose_weights</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">forecast_paths</span>, </span>
<span>                             ingest <span class="op">=</span> <span class="st">"list"</span>,</span>
<span>                             rank_df <span class="op">=</span> <span class="va">mod_rank</span>, </span>
<span>                             rankCol <span class="op">=</span> <span class="st">"MAE"</span>,</span>
<span>                             drop <span class="op">=</span> <span class="fl">1</span>,  <span class="co">#number of lowest ranked models to drop/exclude from ensemble</span></span>
<span>                             team <span class="op">=</span> <span class="st">"CFA"</span>,</span>
<span>                             mod_name <span class="op">=</span> <span class="st">"mae_ensemble"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## → Dropped models: rw1_trend</span></span></code></pre>
<pre><code><span><span class="co">## → Writing ensemble 'mae_ensemble' to analysis directory</span></span></code></pre>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_mae_weights</span></span></code></pre></div>
<pre><code><span><span class="co">##       model   MAE    MAPE maeRank  mean_wis wisRank MAE_weights</span></span>
<span><span class="co">## 1 car_wdays  41.4 0.01247       1  33.54621       1  0.15511855</span></span>
<span><span class="co">## 2    car_rt  41.8 0.01262       2  34.10622       2  0.15500697</span></span>
<span><span class="co">## 3  base_car  41.9 0.01262       3  34.57760       3  0.15497908</span></span>
<span><span class="co">## 4  car_time  41.9 0.01263       4  34.64150       4  0.15497908</span></span>
<span><span class="co">## 5   car_sti  42.1 0.01271       5  34.90884       5  0.15492329</span></span>
<span><span class="co">## 6  car_full  62.8 0.01893       6  49.25360       6  0.14914923</span></span>
<span><span class="co">## 7  base_rw1 325.6 0.09818       7 280.86031       7  0.07584379</span></span></code></pre>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#yet another example, not providing a rankCol -&gt; function assumes equal weighting </span></span>
<span><span class="va">equal_mae_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/propose_weights.html">propose_weights</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">forecast_paths</span>, </span>
<span>                             ingest <span class="op">=</span> <span class="st">"list"</span>,</span>
<span>                             rank_df <span class="op">=</span> <span class="va">mod_rank</span>, </span>
<span>                             <span class="co">#rankCol = NULL,</span></span>
<span>                             drop <span class="op">=</span> <span class="fl">1</span>,  <span class="co">#issues warning, dropping models without a ranking criteria</span></span>
<span>                             team <span class="op">=</span> <span class="st">"CFA"</span>,</span>
<span>                             mod_name <span class="op">=</span> <span class="st">"equal_mae_ensemble"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #BB0000;">✖</span> No rankCol but dropping models? Models will be dropped from end of list!</span></span></code></pre>
<pre><code><span><span class="co">## <span style="color: #BBBB00;">!</span> No rankCol provided, ensemble assumes equal weighting</span></span></code></pre>
<pre><code><span><span class="co">## → Dropped models: rw1_trend</span></span></code></pre>
<pre><code><span><span class="co">## → Writing ensemble 'equal_mae_ensemble' to analysis directory</span></span></code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">equal_mae_weights</span></span></code></pre></div>
<pre><code><span><span class="co">##       model   MAE    MAPE maeRank  mean_wis wisRank rankCol rankCol_weights</span></span>
<span><span class="co">## 1 car_wdays  41.4 0.01247       1  33.54621       1       1       0.1428571</span></span>
<span><span class="co">## 2    car_rt  41.8 0.01262       2  34.10622       2       1       0.1428571</span></span>
<span><span class="co">## 3  base_car  41.9 0.01262       3  34.57760       3       1       0.1428571</span></span>
<span><span class="co">## 4  car_time  41.9 0.01263       4  34.64150       4       1       0.1428571</span></span>
<span><span class="co">## 5   car_sti  42.1 0.01271       5  34.90884       5       1       0.1428571</span></span>
<span><span class="co">## 6  car_full  62.8 0.01893       6  49.25360       6       1       0.1428571</span></span>
<span><span class="co">## 7  base_rw1 325.6 0.09818       7 280.86031       7       1       0.1428571</span></span></code></pre>
<div class="section level3">
<h3 id="ensemble-re-scoring">Ensemble Re-scoring<a class="anchor" aria-label="anchor" href="#ensemble-re-scoring"></a>
</h3>
<p>Now that new ensembles have been added to the ‘forecasts’ directory,
comparison scores can be recalculated.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">myDir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">su_yaml</span><span class="op">$</span><span class="va">out_dir_name</span>, <span class="st">"forecasts"</span><span class="op">)</span></span>
<span><span class="va">new_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score_MAE.html">score_MAE</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">myDir</span>, truth<span class="op">=</span><span class="va">my_truth</span>, ingest <span class="op">=</span> <span class="st">"path"</span>, missing <span class="op">=</span> <span class="st">"remove"</span><span class="op">)</span> </span></code></pre></div>
<pre><code><span><span class="co">## → A total of 319 forecasts weren't evaluatd due lack of truth data</span></span></code></pre>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_mae</span></span></code></pre></div>
<pre><code><span><span class="co">##                 model   MAE    MAPE maeRank</span></span>
<span><span class="co">## 1           car_wdays  41.4 0.01247       1</span></span>
<span><span class="co">## 2              car_rt  41.8 0.01262       2</span></span>
<span><span class="co">## 3            base_car  41.9 0.01262       3</span></span>
<span><span class="co">## 4            car_time  41.9 0.01263       4</span></span>
<span><span class="co">## 5             car_sti  42.1 0.01271       5</span></span>
<span><span class="co">## 6        mae_ensemble  49.2 0.01485       6</span></span>
<span><span class="co">## 7  equal_mae_ensemble  60.4 0.01820       7</span></span>
<span><span class="co">## 8            car_full  62.8 0.01893       8</span></span>
<span><span class="co">## 9        wis_ensemble  70.6 0.02130       9</span></span>
<span><span class="co">## 10           base_rw1 325.6 0.09818      10</span></span>
<span><span class="co">## 11          rw1_trend 353.3 0.10652      11</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="historic-forecasts">Historic Forecasts<a class="anchor" aria-label="anchor" href="#historic-forecasts"></a>
</h3>
<p>The <em>get_hub_forecasts()</em> function retrieves forecasts
previously submitted to the <a href="https://github.com/reichlab/covid19-forecast-hub" class="external-link">covid19-forecast-hub</a>.</p>
<p>Similar to <em>get_covid19_obs()</em>, there are options to load from
a local parquet cache (source=“cache”) as indexed with the <a href="https://github.com/cdcent/covid19Forecasts" class="external-link"><strong>Covid19Forecasts</strong>
package</a>(private repo) or to load “test” data included with the
package. There is also the an option to use the <a href="https://github.com/reichlab/covidHubUtils" class="external-link"><strong>covidHubUtils</strong>
package</a> to download data directly from covid19-forecast-hub.</p>
<p>The queried results can also be filtered to specific models using the
‘models=’ option. If not set, the ‘model=’ options defaults to forecasts
from the COVIDhub-trained_ensemble, COVIDhub-ensemble, and
COVIDhub-baseline models.</p>
<p>By default, <em>get_hub_forecasts()</em> returns forecasts for the
forecast period specified during initial setup using
<em>setup_analysis()</em>.</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hist_forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_hub_forecasts.html">get_hub_forecasts</a></span><span class="op">(</span>source <span class="op">=</span> <span class="st">"covidHubUtils"</span>,</span>
<span>                                    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"COVIDhub-trained_ensemble"</span>, <span class="st">"COVIDhub-baseline"</span>, <span class="st">"COVIDhub-ensemble"</span><span class="op">)</span>,</span>
<span>                                    write_copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## → Loading location crosswalk</span></span></code></pre>
<pre><code><span><span class="co">## <span style="font-weight: bold;">Rows: </span><span style="color: #0000BB;">57</span> <span style="font-weight: bold;">Columns: </span><span style="color: #0000BB;">4</span></span></span>
<span><span class="co">## <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Column specification</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">## <span style="font-weight: bold;">Delimiter:</span> "|"</span></span>
<span><span class="co">## <span style="color: #BB0000;">chr</span> (4): STATE, STUSAB, STATE_NAME, STATENS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span>
<span><span class="co">## → Fetching COVID-19 forecasts using covidHubUtils</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## get_token(): POST: https://zoltardata.com/api-token-auth/</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## get_resource(): GET: https://zoltardata.com/api/projects/</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## get_resource(): GET: https://zoltardata.com/api/project/44/models/</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## get_resource(): GET: https://zoltardata.com/api/project/44/timezeros/</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## → Writing forecast data to analysis directory</span></span></code></pre>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">hist_forecasts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 103032      7</span></span></code></pre>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">hist_forecasts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                       model forecast_date location target_end_date     type</span></span>
<span><span class="co">## 1 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24    point</span></span>
<span><span class="co">## 2 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24 quantile</span></span>
<span><span class="co">## 3 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24 quantile</span></span>
<span><span class="co">## 4 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24 quantile</span></span>
<span><span class="co">## 5 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24 quantile</span></span>
<span><span class="co">## 6 COVIDhub-trained_ensemble    2021-08-23       01      2021-08-24 quantile</span></span>
<span><span class="co">##   quantile value</span></span>
<span><span class="co">## 1       NA   495</span></span>
<span><span class="co">## 2    0.010   369</span></span>
<span><span class="co">## 3    0.025   384</span></span>
<span><span class="co">## 4    0.050   395</span></span>
<span><span class="co">## 5    0.100   404</span></span>
<span><span class="co">## 6    0.150   412</span></span></code></pre>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#because data is formatted to same standard, functions can read</span></span>
<span><span class="va">hub_rank</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score_WIS.html">score_WIS</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">hist_forecasts</span>, truth<span class="op">=</span><span class="va">my_truth</span>, </span>
<span>                      ingest <span class="op">=</span> <span class="st">"dataframe"</span>, missing <span class="op">=</span> <span class="st">"remove"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hub_rank</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_wis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">WIS</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 2</span></span></span>
<span><span class="co">##   model                     mean_wis</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> COVIDhub-baseline             45.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> COVIDhub-ensemble             50.6</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> COVIDhub-trained_ensemble     68.2</span></span></code></pre>
<p><strong>Combine with CovidCAR models</strong><br>
The <em>plot_forecasts_compare()</em> function combines
<em>plot_WIS_lines()</em> and <em>score_WIS()</em> to make a model WIS
comparison line plot. The ‘hub_forecasts’ option facilitates direct use
of imported historical forecast data from the Covid19-forecast-hub.</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_forecasts_compare.html">plot_forecasts_compare</a></span><span class="op">(</span>forecast_data <span class="op">=</span> <span class="va">myDir</span>, truth<span class="op">=</span><span class="va">my_truth</span>, ingest <span class="op">=</span> <span class="st">"path"</span>,</span>
<span>                                  hub_forecasts <span class="op">=</span> <span class="va">hist_forecasts</span>, <span class="co">#historic forecasts</span></span>
<span>                                  scale_model <span class="op">=</span> <span class="st">"COVIDhub-baseline"</span>,</span>
<span>                                  limit <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                  missing <span class="op">=</span> <span class="st">"remove"</span>,</span>
<span>                                  write_copy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## → A total of 7337 predictions weren't evalauted due lack of truth data</span></span></code></pre>
<pre><code><span><span class="co">## → Writing comparison scores to analysis directory</span></span></code></pre>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">my_plot</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "gg"     "ggplot"</span></span></code></pre>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_plot</span></span></code></pre></div>
<p><img src="introduction_files/figure-html/unnamed-chunk-39-1.png" width="700"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by John Humphreys.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
